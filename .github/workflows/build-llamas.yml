name: build-llamas

on:
  workflow_dispatch:
  push:
    tags: ['v*']

permissions:
  contents: write

env:
  PROJECT_REPO: ggml-org/llama.cpp
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            triplet: macos-arm64-metal
            cmake_flags: >
              -DGGML_METAL=ON
              -DGGML_METAL_EMBED_LIBRARY=ON
              -DCMAKE_OSX_ARCHITECTURES=arm64
              -DBUILD_SHARED_LIBS=OFF
              -DLLAMA_STATIC=ON
              -DLLAMA_CURL=OFF
          - os: ubuntu-22.04
            triplet: linux-x86_64
            cmake_flags: >
              -DBUILD_SHARED_LIBS=OFF
              -DLLAMA_STATIC=ON
          - os: windows-2022
            triplet: windows-x86_64
            cmake_flags: >
              -DBUILD_SHARED_LIBS=OFF
              -DLLAMA_STATIC=ON

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout llama.cpp
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PROJECT_REPO }}
          fetch-depth: 1

      # -------------------- deps --------------------
      - name: Deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libcurl4-openssl-dev

      - name: Deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake curl || true

      - name: Deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install cmake -y --installargs 'ADD_CMAKE_TO_PATH=System' || $true

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git clone https://github.com/microsoft/vcpkg.git $env:USERPROFILE\vcpkg
          & $env:USERPROFILE\vcpkg\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=$env:USERPROFILE\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install curl via vcpkg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" install curl:x64-windows

      - name: List vcpkg installed (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" list

      # -------------------- build --------------------
      - name: Configure (CMake) [Linux/macOS]
        if: runner.os != 'Windows'
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ${{ matrix.cmake_flags }}

      - name: Configure (CMake) [Windows + vcpkg/curl]
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $args = @(
            '-S', '.',
            '-B', 'build',
            "-DCMAKE_BUILD_TYPE=$env:BUILD_TYPE",
            "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake",
            '-DBUILD_SHARED_LIBS=OFF',
            '-DLLAMA_STATIC=ON'
          )
          & cmake @args

      - name: Build [Linux/macOS]
        if: runner.os != 'Windows'
        run: cmake --build build --config ${BUILD_TYPE} -j

      # -------------------- verify (no shared libs) --------------------
      - name: Verify static linking (macOS)
        if: runner.os == 'macOS'
        run: |
          otool -L build/bin/llama-cli || true
          # Fail if the binary still expects libllama.dylib
          ! otool -L build/bin/llama-cli | grep -q "libllama.dylib"

      - name: Verify static linking (Linux)
        if: runner.os == 'Linux'
        run: |
          ldd build/bin/llama-cli || true
          # Fail if it links to libllama.so
          ! ldd build/bin/llama-cli | grep -q "libllama.so"

      - name: Verify static linking (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path build\bin\llama.dll) { throw "Unexpected shared library found: llama.dll" }

      - name: Build [Windows]
        if: runner.os == 'Windows'
        shell: pwsh
        run: cmake --build build --config ${env:BUILD_TYPE} -j

      # -------------------- package --------------------
      - name: Stage files (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          rm -rf dist && mkdir -p dist/llama/bin
          cp LICENSE dist/llama/LICENSE.llama.cpp || true
          cp -a build/bin/* dist/llama/bin/ || true
          chmod +x dist/llama/bin/* || true

      - name: Stage files (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          New-Item -ItemType Directory -Force -Path dist\llama\bin | Out-Null
          Copy-Item LICENSE dist\llama\LICENSE.llama.cpp -ErrorAction SilentlyContinue
          $releaseBin = "build\bin\Release"
          $flatBin    = "build\bin"
          if (Test-Path $releaseBin) {
            Copy-Item "$releaseBin\*.exe" dist\llama\bin\ -ErrorAction SilentlyContinue
          } elseif (Test-Path $flatBin) {
            Copy-Item "$flatBin\*.exe" dist\llama\bin\ -ErrorAction SilentlyContinue
          } else {
            Write-Host "No Windows binaries found under build\bin or build\bin\Release"
          }

      - name: Upload artifact (folder, uncompressed)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.triplet }}
          path: dist/llama
          if-no-files-found: error

  release:
    needs: [build]
    runs-on: ubuntu-22.04
    steps:
      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Download artifacts (keep per-artifact folders)
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: false   # keep each artifact in its own dir; no extra wrapping
          # archive-format not set -> extracts files, not zips

      - name: Name/version env
        id: name
        run: |
          ver="${GITHUB_REF_NAME:-dev}"; ver="${ver#v}"
          echo "VER=$ver" >> $GITHUB_OUTPUT

      - name: Create final zips (zip the CONTENTS, not the folder)
        run: |
          set -euo pipefail
          cd artifacts
          for d in */ ; do
            triplet="${d%/}"
            archive="llama-${{ steps.name.outputs.VER }}-${triplet}.zip"
            ( cd "$triplet" && zip -r9 "../${archive}" . )
            echo "Created ${archive}"
          done

      - name: Checksums
        run: |
          cd artifacts
          sha256sum *.zip | tee SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: |
            artifacts/*.zip
            artifacts/SHA256SUMS.txt
